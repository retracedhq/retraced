---
assets:
  v1:
  - github:
      repo: retracedhq/api
      path: /base
      dest: ./
      source: private
      ref: "v1.3.13"
  - github:
      repo: retracedhq/api
      path: /templates
      dest: ./
      source: private
      ref: "v1.3.13"
  - inline:
      dest: scripts/install.sh
      mode: 755
      contents: |
        #!/bin/sh
        set -euo pipefail
        kubectl create namespace {{repl ConfigOption "namespace"}}

        kubectl create secret docker-registry auditlog-imagepull-secret \
            --namespace {{repl ConfigOption "namespace"}} \
            --docker-server registry.replicated.com \
            --docker-username {{repl Installation "customer_id"}} \
            --docker-password {{repl Installation "installation_id"}} \
            --docker-email deprecated@example.com

        kubectl apply -f rendered.yaml

  - inline:
      dest: scripts/test.sh
      mode: 755
      contents: |
        #!/bin/sh
        set -euo pipefail
        echo "tests coming soon"

  - inline:
      dest: tf/empty.tf
      mode: 755
      contents: |
        #an empty terraform file

  - google_gke:
      when: '{{repl and (ConfigOptionEquals "k8s_target_value" "k8s_target_provision_k8s") (ConfigOptionEquals "provision_k8s" "provision_k8s_gcp")}}'
      dest: tf/new_vpc.tf
      credentials: '{{repl ConfigOption "credentials" | Base64Encode}}'
      project: '{{repl ConfigOption "gcp_project" }}'
      region: '{{repl ConfigOption "gcp_region" }}'
      cluster_name: 'auditlog'
      zone: '{{repl ConfigOption "gcp_zone" }}'
      initial_node_count: '{{repl ConfigOption "gcp_cluster_size" }}'
      machine_type: '{{repl ConfigOption "gcp_machine_type" }}'

lifecycle:
  v1:
  - message:
      contents: |
        Audit Log
        =========

        This tool will walk you through several steps to
        allow you to customize the installation and deploy Audit Log
        to your kubernetes cluster.

  - config: {}
  - render:
      root: .
  - kustomize:
      base: base
      overlay: overlays/ship
      dest: rendered.yaml
  # - terraform:
  #     path: tf/
  # - kubectlApply:
  #     path: rendered.yaml
  #     kubeconfig: '{{repl GoogleGKE "auditlog"}}'
  - message:
      contents: |
        Assets are almost ready. Fill out the file at

            ./templates/secrets.yaml

        and then deploy that to your cluster separately.

        Then, you can run

            ./scripts/install.sh

        To deploy the audit log to your cluster.

config:
  v1:
  - name: k8s_target
    title: Kubernetes Deployment Target
    description: Select the Kubernetes deployment option you prefer
    items:
    - name: k8s_target_value
      type: select_one
      default: "k8s_target_existing"
      items:
      - name: k8s_target_existing
        title: Existing Cluster
        value: k8s_target_existing
      - name: k8s_target_provision_k8s
        title: Provision a cluster in my cloud provider
        value: k8s_target_provision_k8s

    - name: provision_k8s
      type: select_one
      when: '{{repl ConfigOptionEquals "k8s_target_value" "k8s_target_provision_k8s"}}'
      default: "provision_k8s_aws"
      items:
      - name: provision_k8s_aws
        title: AWS EKS
      - name: provision_k8s_azure
        title: Azure AKS
      - name: provision_k8s_gcp
        title: GCP GKE

    - name: aws_access_key_id
      title: AWS Access Key ID
      type: text
      when: '{{repl and (ConfigOptionEquals "k8s_target_value" "k8s_target_provision_k8s") (ConfigOptionEquals "provision_k8s" "provision_k8s_aws")}}'
    - name: aws_secret_access_key
      title: AWS Secret Access Key
      type: password
      when: '{{repl and (ConfigOptionEquals "k8s_target_value" "k8s_target_provision_k8s") (ConfigOptionEquals "provision_k8s" "provision_k8s_aws")}}'
    - name: azure_client_id
      title: Azure Client ID
      type: text
      when: '{{repl and (ConfigOptionEquals "k8s_target_value" "k8s_target_provision_k8s") (ConfigOptionEquals "provision_k8s" "provision_k8s_azure")}}'
    - name: azure_client_secret
      title: Azure Client Secret
      type: password
      when: '{{repl and (ConfigOptionEquals "k8s_target_value" "k8s_target_provision_k8s") (ConfigOptionEquals "provision_k8s" "provision_k8s_azure")}}'
    - name: gcp_project
      title: GCP Project Name
      type: text
      when: '{{repl and (ConfigOptionEquals "k8s_target_value" "k8s_target_provision_k8s") (ConfigOptionEquals "provision_k8s" "provision_k8s_gcp")}}'
    - name: gcp_region
      title: GCP Region Name
      type: text
      default: us-central1
      when: '{{repl and (ConfigOptionEquals "k8s_target_value" "k8s_target_provision_k8s") (ConfigOptionEquals "provision_k8s" "provision_k8s_gcp")}}'
    - name: gcp_zone
      title: GCP Region Name
      type: text
      default: us-central1-b
      when: '{{repl and (ConfigOptionEquals "k8s_target_value" "k8s_target_provision_k8s") (ConfigOptionEquals "provision_k8s" "provision_k8s_gcp")}}'
    - name: gcp_machine_type
      title: GCP Machine type
      type: text
      default: n1-standard-1
      when: '{{repl and (ConfigOptionEquals "k8s_target_value" "k8s_target_provision_k8s") (ConfigOptionEquals "provision_k8s" "provision_k8s_gcp")}}'
    - name: gcp_cluster_size
      title: GCP cluster size
      type: text
      default: 3
      when: '{{repl and (ConfigOptionEquals "k8s_target_value" "k8s_target_provision_k8s") (ConfigOptionEquals "provision_k8s" "provision_k8s_gcp")}}'
    - name: gcp_account_json
      title: GCP IAM Key (account.json)
      type: textarea
      when: '{{repl and (ConfigOptionEquals "k8s_target_value" "k8s_target_provision_k8s") (ConfigOptionEquals "provision_k8s" "provision_k8s_gcp")}}'
  - title: Kubernetes
    name: basics
    items:
    - name: namespace
      title: Kubernetes Namespace
      help_text: "The Namespace that you'll deploy the auditlog into"
      type: text
      required: true
      default: 'auditlog'
