FROM node:8.7

ADD . /src
WORKDIR /src

RUN yarn
RUN make deps build pkg


FROM debian:stretch-slim

RUN apt-get update -y && \
    apt-get install -y ca-certificates && \
	rm -rf /var/lib/apt/lists/*

EXPOSE 3000

copy --from=0 /src/api /src/api
copy --from=0 /src/retracedctl /src/bin/retracedctl
COPY --from=0 /src/node_modules/hiredis/build/Release/hiredis.node /src/node_modules/hiredis/build/Release/hiredis.node
COPY --from=0 /src/node_modules/snappy/build/Release/binding.node /src/node_modules/snappy/build/Release/binding.node
COPY --from=0 /src/node_modules/sse4_crc32/build/Release/sse4_crc32.node /src/node_modules/sse4_crc32/build/Release/sse4_crc32.node
WORKDIR /src

CMD ["/src/api"]
